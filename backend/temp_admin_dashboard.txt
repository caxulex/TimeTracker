# Add this content to the end of reports.py

class AdminDashboardStats(BaseModel):
    total_today_seconds: int
    total_today_hours: float
    total_week_seconds: int
    total_week_hours: float
    total_month_seconds: int
    total_month_hours: float
    active_users_today: int
    active_projects: int
    running_timers: int
    by_user: List[UserSummary]


@router.get("/admin/dashboard", response_model=AdminDashboardStats)
async def get_admin_dashboard(
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    \"\"\"Get admin dashboard with all team members' time (super_admin only)\"\"\"
    if current_user.role != "super_admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Admin access required"
        )
    
    now = datetime.now()
    today_start = datetime.combine(now.date(), datetime.min.time())
    week_start = today_start - timedelta(days=now.weekday())
    month_start = today_start.replace(day=1)

    # Total time today (all users)
    today_result = await db.execute(
        select(func.coalesce(func.sum(TimeEntry.duration_seconds), 0))
        .where(TimeEntry.start_time >= today_start)
    )
    total_today = today_result.scalar() or 0

    # Total time this week (all users)
    week_result = await db.execute(
        select(func.coalesce(func.sum(TimeEntry.duration_seconds), 0))
        .where(TimeEntry.start_time >= week_start)
    )
    total_week = week_result.scalar() or 0

    # Total time this month (all users)
    month_result = await db.execute(
        select(func.coalesce(func.sum(TimeEntry.duration_seconds), 0))
        .where(TimeEntry.start_time >= month_start)
    )
    total_month = month_result.scalar() or 0

    # Active users today
    active_users_result = await db.execute(
        select(func.count(func.distinct(TimeEntry.user_id)))
        .where(TimeEntry.start_time >= today_start)
    )
    active_users = active_users_result.scalar() or 0

    # Active projects
    active_projects_result = await db.execute(
        select(func.count(Project.id))
        .where(Project.is_archived == False)
    )
    active_projects = active_projects_result.scalar() or 0

    # Running timers count
    running_result = await db.execute(
        select(func.count(TimeEntry.id))
        .where(TimeEntry.end_time == None)
    )
    running_timers = running_result.scalar() or 0

    # Time by user today
    user_result = await db.execute(
        select(
            TimeEntry.user_id,
            User.name,
            func.coalesce(func.sum(TimeEntry.duration_seconds), 0).label("total_seconds"),
            func.count(TimeEntry.id).label("entry_count")
        )
        .join(User, TimeEntry.user_id == User.id)
        .where(TimeEntry.start_time >= today_start)
        .group_by(TimeEntry.user_id, User.name)
        .order_by(func.sum(TimeEntry.duration_seconds).desc())
    )

    by_user = []
    for row in user_result.all():
        by_user.append(UserSummary(
            user_id=row.user_id,
            user_name=row.name,
            total_seconds=row.total_seconds or 0,
            total_hours=round((row.total_seconds or 0) / 3600, 2),
            entry_count=row.entry_count
        ))

    return AdminDashboardStats(
        total_today_seconds=total_today,
        total_today_hours=round(total_today / 3600, 2),
        total_week_seconds=total_week,
        total_week_hours=round(total_week / 3600, 2),
        total_month_seconds=total_month,
        total_month_hours=round(total_month / 3600, 2),
        active_users_today=active_users,
        active_projects=active_projects,
        running_timers=running_timers,
        by_user=by_user
    )
